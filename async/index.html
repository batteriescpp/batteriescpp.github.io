
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.1">
    
    
      
        <title><batteries/async/...> : Async Tasks and I/O - Batteries C++</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#batttask" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Batteries C++" class="md-header__button md-logo" aria-label="Batteries C++" data-md-component="logo">
      <img width="100px" src="/images/BatteriesLogo.png">
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Batteries C++
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              &lt;batteries/async/...&gt; : Async Tasks and I/O
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Batteries C++" class="md-nav__button md-logo" aria-label="Batteries C++" data-md-component="logo">
      <img width="100px" src="/images/BatteriesLogo.png">
    </a>
    Batteries C++
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Headers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Headers" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Headers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/assert.hpp" class="md-nav__link">
        batteries/assert.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/async" class="md-nav__link">
        batteries/async/*
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/case_of.hpp" class="md-nav__link">
        batteries/case_of.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/cpu_align.hpp" class="md-nav__link">
        batteries/cpu_align.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/status.hpp" class="md-nav__link">
        batteries/status.hpp
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/_autogen/Files/" class="md-nav__link">
        Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="/_autogen/Classes/" class="md-nav__link">
        Classes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#batttask" class="md-nav__link">
    batt::Task
  </a>
  
    <nav class="md-nav" aria-label="batt::Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#description" class="md-nav__link">
    Description
  </a>
  
    <nav class="md-nav" aria-label="Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-io" class="md-nav__link">
    Asynchronous I/O
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-scheduling-and-priorities" class="md-nav__link">
    Task Scheduling and Priorities
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    Methods
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batttasktaskexecutor-stack_size-body_fn" class="md-nav__link">
    batt::Task::Task(executor, stack_size, body_fn)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttasktaskexecutor-body_fn-name-stack_size-stack_type-priority" class="md-nav__link">
    batt::Task::Task(executor, body_fn, name, stack_size, stack_type, priority)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskawait" class="md-nav__link">
    batt::Task::await
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskbacktrace_all" class="md-nav__link">
    batt::Task::backtrace_all
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcall_when_done" class="md-nav__link">
    batt::Task::call_when_done
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcurrent" class="md-nav__link">
    batt::Task::current
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcurrent_name" class="md-nav__link">
    batt::Task::current_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcurrent_priority" class="md-nav__link">
    batt::Task::current_priority
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcurrent_stack_pos" class="md-nav__link">
    batt::Task::current_stack_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskcurrent_stack_pos_of" class="md-nav__link">
    batt::Task::current_stack_pos_of
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskdefault_name" class="md-nav__link">
    batt::Task::default_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttasksleep" class="md-nav__link">
    batt::Task::sleep
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskget_executor" class="md-nav__link">
    batt::Task::get_executor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskget_priority" class="md-nav__link">
    batt::Task::get_priority
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskid" class="md-nav__link">
    batt::Task::id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskjoin" class="md-nav__link">
    batt::Task::join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskname" class="md-nav__link">
    batt::Task::name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskset_priority" class="md-nav__link">
    batt::Task::set_priority
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskstack_pos" class="md-nav__link">
    batt::Task::stack_pos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskstack_pos_of" class="md-nav__link">
    batt::Task::stack_pos_of
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttasktry_join" class="md-nav__link">
    batt::Task::try_join
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskwake" class="md-nav__link">
    batt::Task::wake
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batttaskyield" class="md-nav__link">
    batt::Task::yield
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battwatcht" class="md-nav__link">
    batt::Watch&lt;T&gt;
  </a>
  
    <nav class="md-nav" aria-label="batt::Watch&lt;T&gt;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary_1" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#description_1" class="md-nav__link">
    Description
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods_1" class="md-nav__link">
    Methods
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#battwatchwatch" class="md-nav__link">
    batt::Watch::Watch()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchwatcht-init_value" class="md-nav__link">
    batt::Watch::Watch(T init_value)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchasync_wait" class="md-nav__link">
    batt::Watch::async_wait
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchawait_equal" class="md-nav__link">
    batt::Watch::await_equal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchawait_modify" class="md-nav__link">
    batt::Watch::await_modify
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchawait_not_equal" class="md-nav__link">
    batt::Watch::await_not_equal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchawait_true" class="md-nav__link">
    batt::Watch::await_true
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchclose" class="md-nav__link">
    batt::Watch::close
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchfetch_add" class="md-nav__link">
    batt::Watch::fetch_add
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchfetch_and" class="md-nav__link">
    batt::Watch::fetch_and
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchfetch_or" class="md-nav__link">
    batt::Watch::fetch_or
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchfetch_sub" class="md-nav__link">
    batt::Watch::fetch_sub
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchget_value" class="md-nav__link">
    batt::Watch::get_value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchis_closed" class="md-nav__link">
    batt::Watch::is_closed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchmodify" class="md-nav__link">
    batt::Watch::modify
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchmodify_if" class="md-nav__link">
    batt::Watch::modify_if
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battwatchset_value" class="md-nav__link">
    batt::Watch::set_value
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#battmutext" class="md-nav__link">
    batt::Mutex&lt;T&gt;
  </a>
  
    <nav class="md-nav" aria-label="batt::Mutex&lt;T&gt;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary_2" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#description_2" class="md-nav__link">
    Description
  </a>
  
    <nav class="md-nav" aria-label="Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lock-via-guard-class-similar-to-stdunique_lock" class="md-nav__link">
    Lock via guard class (similar to std::unique_lock)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-function-with-lock-acquired" class="md-nav__link">
    Run function with lock acquired
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-free-access-to-t" class="md-nav__link">
    Lock-free access to T
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="batteriesasync-async-tasks-and-io">&lt;batteries/async/...&gt; : Async Tasks and I/O<a class="headerlink" href="#batteriesasync-async-tasks-and-io" title="Permanent link">&#128279;</a></h1>
<table>
<thead>
<tr>
<th align="left">Quick Reference</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#batttask">batt::Task</a></td>
<td align="left"><a href="#battwatcht">batt::Watch&lt;T&gt;</a></td>
<td align="left"><a href="#battmutext">batt::Mutex&lt;T&gt;</a></td>
</tr>
</tbody>
</table>
<h2 id="batttask">batt::Task<a class="headerlink" href="#batttask" title="Permanent link">&#128279;</a></h2>
<h3 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&#128279;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/task.hpp&gt;</span><span class="cp"></span>
</code></pre></div></td></tr></table></div>
<table>
<thead>
<tr>
<th align="left">Constructors</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#batttasktaskexecutor-stack_size-body_fn">Task(executor, stack_size, body_fn)</a></td>
</tr>
<tr>
<td align="left"><a href="#batttasktaskexecutor-body_fn-name-stack_size-stack_type-priority">Task(executor, body_fn, name, stack_size, stack_type, priority)</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Static Methods</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#batttaskcurrent">current</a></td>
<td align="left"><a href="#batttaskcurrent_name">current_name</a></td>
<td align="left"><a href="#batttaskcurrent_priority">current_priority</a></td>
</tr>
<tr>
<td align="left"><a href="#batttaskcurrent_stack_pos">current_stack_pos</a></td>
<td align="left"><a href="#batttaskcurrent_stack_pos_of">current_stack_pos_of</a></td>
<td align="left"><a href="#batttaskdefault_name">default_name</a></td>
</tr>
<tr>
<td align="left"><a href="#batttaskyield">yield</a></td>
<td align="left"><a href="#batttasksleep">sleep</a></td>
<td align="left"><a href="#batttaskawait">await</a></td>
</tr>
<tr>
<td align="left"><a href="batttaskbacktrace_all">backtrace_all</a></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Getters</th>
<th align="left"></th>
<th align="left">Modifiers</th>
<th align="left">Synchronization</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#batttaskid">id</a></td>
<td align="left"><a href="#batttaskname">name</a></td>
<td align="left"><a href="#batttasktry_join">try_join</a></td>
<td align="left"><a href="#batttaskjoin">join</a></td>
</tr>
<tr>
<td align="left"><a href="#batttaskget_executor">get_executor</a></td>
<td align="left"><a href="#batttaskget_priority">get_priority</a></td>
<td align="left"><a href="#batttaskset_priority">set_priority</a></td>
<td align="left"><a href="#batttaskcall_when_done">call_when_done</a></td>
</tr>
<tr>
<td align="left"><a href="#batttaskstack_pos">stack_pos</a></td>
<td align="left"><a href="#batttaskstack_pos_of">stack_pos_of</a></td>
<td align="left"><a href="#batttaskwake">wake</a></td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h3 id="description">Description<a class="headerlink" href="#description" title="Permanent link">&#128279;</a></h3>
<p>A <code>batt::Task</code> is similar to <code>std::thread</code>, but much lighter weight.  Like <code>std::thread</code>, each <code>batt::Task</code> has an independent call stack.  Unlike <code>std::thread</code>, however, <code>batt::Task</code> is implemented 100% in user space, and does not support preemption.  This makes the context swap overhead of <code>batt::Task</code> very low in comparison to a <code>std::thread</code>, which means it is possible to have many more <code>batt::Task</code> instances without losing efficiency.</p>
<h4 id="asynchronous-io">Asynchronous I/O<a class="headerlink" href="#asynchronous-io" title="Permanent link">&#128279;</a></h4>
<p>The primary use case for <code>batt::Task</code> is to support asynchronous I/O for efficiency, while retaining the programming model of traditional threads.  This makes asynchronous code much easier to write, read, debug, and maintain than equivalent code using asynchronous continuation handlers (in the style of Boost Asio or Node.js).</p>
<p>An important feature of <code>batt::Task</code> to highlight is the static method <a href="#batttaskawait">batt::Task::await</a>.  This method allows the use of asynchronous continuation handler-based APIs (e.g., Boost Asio) in a "blocking" style.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span>
<span class="normal"><a href="#__codelineno-1-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/task.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/io_result.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/assert.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/utility.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/asio/io_context.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/asio/ip/tcp.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// Some function to get a server endpoint to which to connect.</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="c1">//</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="k">extern</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">endpoint</span><span class="w"> </span><span class="nf">get_server_endpoint</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="c1">// Create an io_context to schedule our Task and manage all asynchronous I/O.</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">io_context</span><span class="w"> </span><span class="n">io</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="c1">// Create a TCP/IP socket; we will use this to connect to the server endpoint.</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">socket</span><span class="w"> </span><span class="n">s</span><span class="p">{</span><span class="n">io</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">  </span><span class="c1">// Launch a task to act as our client.</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">client_task</span><span class="p">{</span><span class="n">io</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="cm">/*body_fn=*/</span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">      </span><span class="c1">// Connect to the server.  batt::Task::await will not return until the handler passed</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">      </span><span class="c1">// to `async_connect` has been invoked.</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">      </span><span class="c1">//</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">system</span><span class="o">::</span><span class="n">error_code</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">await</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">system</span><span class="o">::</span><span class="n">error_code</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">handler</span><span class="p">){</span><span class="w"></span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">        </span><span class="n">s</span><span class="p">.</span><span class="n">async_connect</span><span class="p">(</span><span class="n">get_server_endpoint</span><span class="p">(),</span><span class="w"> </span><span class="n">BATT_FORWARD</span><span class="p">(</span><span class="n">handler</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">      </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">      </span><span class="n">BATT_CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">      </span><span class="c1">// Interact with the server via the connected socket...</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">    </span><span class="p">}};</span><span class="w"></span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">  </span><span class="c1">// VERY IMPORTANT: without this line, nothing will happen!</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>All continuation handler based async APIs require a callback (the continuation handler).  In order to simplify the code, we want to "pause" our code until the I/O is finished, but the async API, <code>async_connect</code> in this case, will return immediately.  <a href="#batttaskawait">batt::Task::await</a> gives us access to the "continuation" of the task, in this case everything that happens after <code>await</code> returns, as a handler that can be passed directly to <code>async_connect</code>.  All the context swapping, scheduling, memory managment, and synchronization is handled automatically by <code>batt::Task</code>, allowing the programmer to focus on the application's natural flow of control, and not the mechanics used to implement this flow.</p>
<h4 id="task-scheduling-and-priorities">Task Scheduling and Priorities<a class="headerlink" href="#task-scheduling-and-priorities" title="Permanent link">&#128279;</a></h4>
<p>When a <code>batt::Task</code> is created, it is passed a Boost Asio executor object.  All execution of task code on the task's stack will happen via <code>boost::asio::dispatch</code> or <code>boost::asio::post</code> using this executor.  NOTE: this means if, for example, you use the executor from a <code>boost::asio::io_context</code> to create a task, that task will not run unless you call <code>io_context::run()</code>!</p>
<p>A running <code>batt::Task</code> is never preempted by another task.  Instead it must yield control of the current thread to allow another task to run.  There are four ways to do this:</p>
<ul>
<li><a href="#batttaskjoin">batt::Task::join()</a></li>
<li><a href="#batttaskawait">batt::Task::await()</a></li>
<li><a href="#batttaskyield">batt::Task::yield()</a></li>
<li><a href="#batttasksleep">batt::Task::sleep()</a></li>
</ul>
<p>WARNING: if you use a kernel or standard library synchronization mechanism or blocking call, for example <code>std::mutex</code>, from inside a <code>batt::Task</code>, that task WILL NOT YIELD!  This is why the Batteries Async library contains its own synchronization primitives, like <code>batt::Watch</code>, <code>batt::Queue</code>, and <code>batt::Mutex</code>.  All of these primitives are implemented on top one or more of the four methods enumerated above.</p>
<p>Each <code>batt::Task</code> is assigned a scheduling priority, which is a signed 32-bit integer.  Greater values of the priority int mean more urgent priority; lesser values mean less urgency.  Even though tasks don't interrupt each other (i.e. preemption), they sometimes perform actions that cause another task to move from a "waiting" state to a "ready to run" state.  For example, one task may be blocked inside a call to <code>batt::Watch&lt;T&gt;::await_equal</code>, and another task (let's call it the "notifier") may call <code>batt::Watch&lt;T&gt;::set_value</code>, activating the first task (let's call it the "listener").  As noted above, the newly activated ("listener") task will be run via <code>boost::asio::dispatch</code> or <code>boost::asio::post</code>.  Which mechanism is used depends on the relative priority of the two tasks:</p>
<ul>
<li>If the "notifier" has a higher (numerically greater) priority value than the "listener", the "listener" is scheduled via <code>boost::asio::post</code>.</li>
<li>Otherwise, the "notifier" is immediately suspended and re-scheduled via <code>boost::asio::post</code>; then the "listener" is scheduled via <code>boost::asio::dispatch</code>.</li>
</ul>
<p>In any case, activating another task will <em>not</em> cause a running task to go from a "running" state to a "waiting" state.  It may however "bounce" it to another thread, or to be pushed to the back of an execution queue.  This only matters when there are more tasks ready to run than there are available threads for a given ExecutionContext: higher priority tasks are scheduled before lower priority ones in general.</p>
<p>NOTE: you may still end up with a priority inversion situation when multiple tasks with different priorities are <code>boost::asio::post</code>-ed to the same queue.  In this case, there is no mechanism currently for re-ordering the tasks to give preference based on priority.</p>
<p>Overall, it is best to consider priority "best-effort" rather than a guarantee of scheduling order.  It should be used for performance tuning, not to control execution semantics in a way that affects the functional behavior of a program.</p>
<h3 id="methods">Methods<a class="headerlink" href="#methods" title="Permanent link">&#128279;</a></h3>
<h4 id="batttasktaskexecutor-stack_size-body_fn"><a href="#batttask">batt::Task</a>::Task(executor, stack_size, body_fn)<a class="headerlink" href="#batttasktaskexecutor-stack_size-body_fn" title="Permanent link">&#128279;</a></h4>
<p>Create a new Task with a custom stack size.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">BodyFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">explicit</span><span class="w"> </span><span class="n">Task</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">any_io_executor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ex</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">              </span><span class="n">batt</span><span class="o">::</span><span class="n">StackSize</span><span class="w"> </span><span class="n">stack_size</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">              </span><span class="n">BodyFn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">body_fn</span><span class="p">)</span><span class="w"> </span><span class="k">noexcept</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttasktaskexecutor-body_fn-name-stack_size-stack_type-priority"><a href="#batttask">batt::Task</a>::Task(executor, body_fn, name, stack_size, stack_type, priority)<a class="headerlink" href="#batttasktaskexecutor-body_fn-name-stack_size-stack_type-priority" title="Permanent link">&#128279;</a></h4>
<p>Create a new Task, optionally setting name, stack size, stack type, and priority.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span>
<span class="normal"><a href="#__codelineno-3-6">6</a></span>
<span class="normal"><a href="#__codelineno-3-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">BodyFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">explicit</span><span class="w"> </span><span class="n">Task</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">any_io_executor</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ex</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">              </span><span class="n">BodyFn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">body_fn</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">              </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Task</span><span class="o">::</span><span class="n">default_name</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">              </span><span class="n">StackSize</span><span class="w"> </span><span class="n">stack_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">StackSize</span><span class="p">{</span><span class="mi">512</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">              </span><span class="n">batt</span><span class="o">::</span><span class="n">StackType</span><span class="w"> </span><span class="n">stack_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">StackType</span><span class="o">::</span><span class="n">kFixedSize</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">              </span><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Priority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">)</span><span class="w"> </span><span class="k">noexcept</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The default priority for a Task is the current task priority plus 100; this means that a new Task by default will always "soft-preempt" the currently running task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskawait"><a href="#batttask">batt::Task</a>::await<a class="headerlink" href="#batttaskawait" title="Permanent link">&#128279;</a></h4>
<p>Block the current thread until some asynchronous operation completes.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span>
<span class="normal"><a href="#__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">R</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Fn</span><span class="o">=</span><span class="kt">void</span><span class="p">(</span><span class="n">Handler</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">static</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">Fn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w">                                               </span><span class="c1">// (1)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">R</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">Fn</span><span class="o">=</span><span class="kt">void</span><span class="p">(</span><span class="n">Handler</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">static</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">batt</span><span class="o">::</span><span class="n">StaticType</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Fn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w">                          </span><span class="c1">// (2)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">future_result</span><span class="p">);</span><span class="w">  </span><span class="c1">// (3)</span>
</code></pre></div></td></tr></table></div>
<p>Overloads (1) &amp; (2) take a function whose job is to initiate an asynchronous operation.  Since async ops require a callback (which is invoked when the op completes), the function <code>fn</code> is passed a <code>Handler</code> which serves to wake up the task and resume its execution.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">socket</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="k">using</span><span class="w"> </span><span class="n">ReadResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">system</span><span class="o">::</span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="n">ReadResult</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">await</span><span class="o">&lt;</span><span class="n">ReadResult</span><span class="o">&gt;</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">async_read_some</span><span class="p">(</span><span class="n">buffers</span><span class="p">,</span><span class="w"> </span><span class="n">BATT_FORWARD</span><span class="p">(</span><span class="n">handler</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Error! ec=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">first</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; bytes were read.&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>The template parameter <code>R</code> is the return type of the <code>await</code> operation.  <code>R</code> can be any type that is movable and constructible from the arguments passed to the callback <code>Handler</code>.  In the example above, we define <code>R</code> to be a <code>std::pair</code> of the error code and the count of bytes read (size_t).  This is the exact signature required by the async op initiated inside the lambda expression passed to <code>await</code>.  When the socket implementation causes <code>handler(ec, n_bytes_read)</code> to be invoked, the <code>Handler</code> provided by <code>batt::Task::await</code> constructs an instance of <code>R</code> by forwarding the handler arguments (<code>auto retval = std::make_pair(ec, n_bytes_read);</code>), and resumes the task that was paused inside <code>await</code>, returning <code>retval</code>.</p>
<h5 id="return-value">Return Value<a class="headerlink" href="#return-value" title="Permanent link">&#128279;</a></h5>
<ul>
<li>(1) &amp; (2): the instance of <code>R</code> constructed from callback arguments.</li>
<li>(3): the value of the passed <code>batt::Future&lt;T&gt;</code> if successful; non-ok status if the future completed with an error.</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskbacktrace_all"><a href="#batttask">batt::Task</a>::backtrace_all<a class="headerlink" href="#batttaskbacktrace_all" title="Permanent link">&#128279;</a></h4>
<p>Dumps stack trace and debug information for all active <code>batt::Task</code>s to stderr.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">static</span><span class="w"> </span><span class="n">i32</span><span class="w"> </span><span class="nf">backtrace_all</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">force</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>If <code>force</code> is true, then this function will attempt to dump debug information for running tasks, even though this may cause data races (if you're debugging a tricky threading issue, sometimes the risk of a crash is outweighed by the benefit of some additional clues about what's going on!).</p>
<h5 id="return-value_1">Return Value<a class="headerlink" href="#return-value_1" title="Permanent link">&#128279;</a></h5>
<p>The number of tasks dumped.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcall_when_done"><a href="#batttask">batt::Task</a>::call_when_done<a class="headerlink" href="#batttaskcall_when_done" title="Permanent link">&#128279;</a></h4>
<p>Attaches a listener callback to the task; this callback will be invoked when the task completes execution.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">F</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">call_when_done</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">handler</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This method can be thought of as an asynchronous version of <a href="#batttaskjoin">join()</a>.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcurrent"><a href="#batttask">batt::Task</a>::current<a class="headerlink" href="#batttaskcurrent" title="Permanent link">&#128279;</a></h4>
<p>Returns a reference to the currently running Task, if there is one.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">current</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>WARNING: if this method is called outside of any <code>batt::Task</code>, behavior is undefined.</p>
<h5 id="return-value_2">Return Value<a class="headerlink" href="#return-value_2" title="Permanent link">&#128279;</a></h5>
<p>The current task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcurrent_name"><a href="#batttask">batt::Task</a>::current_name<a class="headerlink" href="#batttaskcurrent_name" title="Permanent link">&#128279;</a></h4>
<p>Returns the current task name, or "" if there is no current task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="nf">current_name</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>Unlike <a href="#batttaskcurrent">batt::Task::current()</a>, this method is safe to call outside a task.</p>
<h5 id="return-value_3">Return Value<a class="headerlink" href="#return-value_3" title="Permanent link">&#128279;</a></h5>
<p>The current task name.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcurrent_priority"><a href="#batttask">batt::Task</a>::current_priority<a class="headerlink" href="#batttaskcurrent_priority" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">Priority</span><span class="w"> </span><span class="nf">current_priority</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>NOTE: this function is safe to call outside of a task; in this case, the default priority (0) is returned.</p>
<p>See <a href="#task-scheduling-and-priorities">Task Scheduling and Priorities</a>.</p>
<h5 id="return-value_4">Return Value<a class="headerlink" href="#return-value_4" title="Permanent link">&#128279;</a></h5>
<p>The priority of the current task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcurrent_stack_pos"><a href="#batttask">batt::Task</a>::current_stack_pos<a class="headerlink" href="#batttaskcurrent_stack_pos" title="Permanent link">&#128279;</a></h4>
<p>Returns the offset of the current locus of control relative to the base of the stack.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_stack_pos</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_5">Return Value<a class="headerlink" href="#return-value_5" title="Permanent link">&#128279;</a></h5>
<ul>
<li>If called from inside a task, the current stack position in bytes</li>
<li>Else <code>batt::None</code></li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskcurrent_stack_pos_of"><a href="#batttask">batt::Task</a>::current_stack_pos_of<a class="headerlink" href="#batttaskcurrent_stack_pos_of" title="Permanent link">&#128279;</a></h4>
<p>Returns the offset of some address relative to the base of the current task stack.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_stack_pos_of</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>NOTE: If <code>ptr</code> isn't actually on the current task's stack, then this function will still return a number, but it will be essentially a garbage value.  It's up to the caller to make sure that <code>ptr</code> points at something on the task stack.</p>
<h5 id="return-value_6">Return Value<a class="headerlink" href="#return-value_6" title="Permanent link">&#128279;</a></h5>
<ul>
<li>If called from inside a task, the stack offset in bytes of <code>ptr</code></li>
<li>Else <code>batt::None</code></li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskdefault_name"><a href="#batttask">batt::Task</a>::default_name<a class="headerlink" href="#batttaskdefault_name" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">default_name</span><span class="p">()</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_7">Return Value<a class="headerlink" href="#return-value_7" title="Permanent link">&#128279;</a></h5>
<p>The name given to a <code>batt::Task</code> if none is passed into the constructor.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttasksleep"><a href="#batttask">batt::Task</a>::sleep<a class="headerlink" href="#batttasksleep" title="Permanent link">&#128279;</a></h4>
<p>Puts a <code>batt::Task</code> to sleep for the specified real-time duration.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">posix_time</span><span class="o">::</span><span class="n">ptime</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="k">static</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">ErrorCode</span><span class="w"> </span><span class="n">sleep</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Duration</span><span class="o">&amp;</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This operation can be interrupted by a <a href="#batttaskwake">batt::Task::wake()</a>, in which case a "cancelled" error code is returned instead of success (no error).</p>
<p>This method is safe to call outside a task; in this case, it is implemented via <code>std::this_task::sleep_for</code>.</p>
<h5 id="return-value_8">Return Value<a class="headerlink" href="#return-value_8" title="Permanent link">&#128279;</a></h5>
<ul>
<li><code>batt::ErrorCode{}</code> (no error) if the specified duration passed</li>
<li>A value equal to <code>boost::asio::error::operation_aborted</code> if <code>batt::Task::wake()</code> was called on the given task</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskget_executor"><a href="#batttask">batt::Task</a>::get_executor<a class="headerlink" href="#batttaskget_executor" title="Permanent link">&#128279;</a></h4>
<p>Returns a copy of the executor passed to the given task at construction time.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">executor_type</span><span class="w"> </span><span class="nf">get_executor</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_9">Return Value<a class="headerlink" href="#return-value_9" title="Permanent link">&#128279;</a></h5>
<p>The executor for this task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskget_priority"><a href="#batttask">batt::Task</a>::get_priority<a class="headerlink" href="#batttaskget_priority" title="Permanent link">&#128279;</a></h4>
<p>Get the priority of this task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">Priority</span><span class="w"> </span><span class="nf">get_priority</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>See <a href="#task-scheduling-and-priorities">Task Scheduling and Priorities</a>.</p>
<h5 id="return-value_10">Return Value<a class="headerlink" href="#return-value_10" title="Permanent link">&#128279;</a></h5>
<p>The priority of the task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskid"><a href="#batttask">batt::Task</a>::id<a class="headerlink" href="#batttaskid" title="Permanent link">&#128279;</a></h4>
<p>Get the process-unique serial number of this task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">i32</span><span class="w"> </span><span class="nf">id</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_11">Return Value<a class="headerlink" href="#return-value_11" title="Permanent link">&#128279;</a></h5>
<p>The serial number of the task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskjoin"><a href="#batttask">batt::Task</a>::join<a class="headerlink" href="#batttaskjoin" title="Permanent link">&#128279;</a></h4>
<p>Block until the task has finished.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">join</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskname"><a href="#batttask">batt::Task</a>::name<a class="headerlink" href="#batttaskname" title="Permanent link">&#128279;</a></h4>
<p>Get the human-friendly name of this task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="nf">name</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This string is not necessarily unique to this task.  It is optionally passed in when the task is constructed.  The purpose is to identify the task for debugging purposes.</p>
<h5 id="return-value_12">Return Value<a class="headerlink" href="#return-value_12" title="Permanent link">&#128279;</a></h5>
<p>The name of the task.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskset_priority"><a href="#batttask">batt::Task</a>::set_priority<a class="headerlink" href="#batttaskset_priority" title="Permanent link">&#128279;</a></h4>
<p>Set the scheduling priority of this task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">set_priority</span><span class="p">(</span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">Priority</span><span class="w"> </span><span class="n">new_priority</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>See <a href="#task-scheduling-and-priorities">Task Scheduling and Priorities</a>.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskstack_pos"><a href="#batttask">batt::Task</a>::stack_pos<a class="headerlink" href="#batttaskstack_pos" title="Permanent link">&#128279;</a></h4>
<p>Get the byte offset between the <em>current</em> stack position and the base of this task's stack.  This value is only meaningful if this method is called while on the current task.  Usually you should just call <a href="#batttaskcurrent_stack_pos">batt::Task::current_stack_pos()</a> instead.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a>usize stack_pos() const;
</code></pre></div></td></tr></table></div>
<h5 id="return-value_13">Return Value<a class="headerlink" href="#return-value_13" title="Permanent link">&#128279;</a></h5>
<p>The byte offset between the current stack position and the base of this task's stack.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskstack_pos_of"><a href="#batttask">batt::Task</a>::stack_pos_of<a class="headerlink" href="#batttaskstack_pos_of" title="Permanent link">&#128279;</a></h4>
<p>Get the byte offset between the given pointer and the base of this task's stack.  It is up to the caller to make sure that <code>ptr</code> is the address of something on the task's stack.  Usually you should just call <a href="#batttaskcurrent_stack_pos_of">batt::Task::current_stack_pos_of</a> instead.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="n">usize</span><span class="w"> </span><span class="nf">stack_pos_of</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_14">Return Value<a class="headerlink" href="#return-value_14" title="Permanent link">&#128279;</a></h5>
<p>The byte offset between the given pointer and the base of this task's stack.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttasktry_join"><a href="#batttask">batt::Task</a>::try_join<a class="headerlink" href="#batttasktry_join" title="Permanent link">&#128279;</a></h4>
<p>Test whether this task has finished.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">try_join</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This function is guaranteed never to block.</p>
<p>See <a href="#batttaskjoin">batt::Task::join()</a>.</p>
<h5 id="return-value_15">Return Value<a class="headerlink" href="#return-value_15" title="Permanent link">&#128279;</a></h5>
<p><code>true</code> iff the task has finished executing.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskwake"><a href="#batttask">batt::Task</a>::wake<a class="headerlink" href="#batttaskwake" title="Permanent link">&#128279;</a></h4>
<p>Interrupts a call to <code>batt::Task::sleep</code> on the given task.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">wake</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>NOTE: if the given task is suspended for some other reason (i.e., it is not inside a call to <code>batt::Task::sleep</code>), this method will <strong>not</strong> wake the task (in this case it will return <code>false</code>).</p>
<h5 id="return-value_16">Return Value<a class="headerlink" href="#return-value_16" title="Permanent link">&#128279;</a></h5>
<ul>
<li><code>true</code> iff the task was inside a call to <code>sleep</code> and was successfully activated</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="batttaskyield"><a href="#batttask">batt::Task</a>::yield<a class="headerlink" href="#batttaskyield" title="Permanent link">&#128279;</a></h4>
<p>Suspend the current task and immediately schedule it to resume via <code>boost::asio::post</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">yield</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<hr>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h2 id="battwatcht">batt::Watch&lt;T&gt;<a class="headerlink" href="#battwatcht" title="Permanent link">&#128279;</a></h2>
<h3 id="summary_1">Summary<a class="headerlink" href="#summary_1" title="Permanent link">&#128279;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/watch.hpp&gt;</span><span class="cp"></span>
</code></pre></div></td></tr></table></div>
<table>
<thead>
<tr>
<th align="left">Constructors</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battwatchwatch">Watch()</a></td>
</tr>
<tr>
<td align="left"><a href="#battwatchwatcht-init_value">Watch(T)</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Getters</th>
<th align="left">Modifiers</th>
<th align="left"></th>
<th align="left">Synchronization</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battwatchis_closed">is_closed</a></td>
<td align="left"><a href="#battwatchclose">close</a></td>
<td align="left"><a href="#battwatchfetch_add">fetch_add</a></td>
<td align="left"><a href="#battwatchasync_wait">async_wait</a></td>
<td><a href="#battwatchawait_not_equal">await_not_equal</a></td>
</tr>
<tr>
<td align="left"><a href="#battwatchget_value">get_value</a></td>
<td align="left"><a href="#battwatchset_value">set_value</a></td>
<td align="left"><a href="#battwatchfetch_sub">fetch_sub</a></td>
<td align="left"></td>
<td><a href="#battwatchawait_equal">await_equal</a></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><a href="#battwatchmodify">modify</a></td>
<td align="left"><a href="#battwatchfetch_or">fetch_or</a></td>
<td align="left"></td>
<td><a href="#battwatchawait_true">await_true</a></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"><a href="#battwatchmodify_if">modify_if</a></td>
<td align="left"><a href="#battwatchfetch_sub">fetch_and</a></td>
<td align="left"></td>
<td><a href="#battwatchawait_modify">await_modify</a></td>
</tr>
</tbody>
</table>
<h3 id="description_1">Description<a class="headerlink" href="#description_1" title="Permanent link">&#128279;</a></h3>
<p>A <code>batt::Watch</code> is like a <code>std::atomic</code> that you can block on, synchronously and asynchronously.  Like <code>std::atomic</code>, it has methods to atomically get/set/increment/etc.  But unlike <code>std::atomic</code>, you can also block a task waiting for some condition to be true.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/watch.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/assert.hpp&gt;</span><span class="c1">  // for BATT_CHECK_OK</span><span class="cp"></span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/status.hpp&gt;</span><span class="c1">  // for batt::Status</span><span class="cp"></span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Watch</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">done</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">  </span><span class="c1">// Launch some background task that will do stuff, then set `done` </span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">  </span><span class="c1">// to `true` when it is finished.</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">  </span><span class="n">launch_background_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="n">await_equal</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">  </span><span class="n">BATT_CHECK_OK</span><span class="p">(</span><span class="n">status</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h3 id="methods_1">Methods<a class="headerlink" href="#methods_1" title="Permanent link">&#128279;</a></h3>
<h4 id="battwatchwatch"><a href="#battwatcht">batt::Watch</a>::Watch()<a class="headerlink" href="#battwatchwatch" title="Permanent link">&#128279;</a></h4>
<p>Constructs a <code>batt::Watch</code> object with a default-initialized value of <code>T</code>.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchwatcht-init_value"><a href="#battwatcht">batt::Watch</a>::Watch(T init_value)<a class="headerlink" href="#battwatchwatcht-init_value" title="Permanent link">&#128279;</a></h4>
<p>Constructs a <code>batt::Watch</code> object with the given initial value.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchasync_wait"><a href="#battwatcht">batt::Watch</a>::async_wait<a class="headerlink" href="#battwatchasync_wait" title="Permanent link">&#128279;</a></h4>
<p>Invokes the passed handler <code>fn</code> with the described value as soon as one of the following conditions is true:
 * When the Watch value is <em>not</em> equal to the passed value <code>last_seen</code>, invoke <code>fn</code> with the current value of the Watch.
 * When the Watch is closed, invoke <code>fn</code> with <code>batt::StatusCode::kClosed</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">void</span><span class="p">(</span><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">new_value</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="kt">void</span><span class="w"> </span><span class="n">async_wait</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">last_seen</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchawait_equal"><a href="#battwatcht">batt::Watch</a>::await_equal<a class="headerlink" href="#battwatchawait_equal" title="Permanent link">&#128279;</a></h4>
<p>Blocks the current task/thread until the Watch contains the specified value.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Status</span><span class="w"> </span><span class="nf">await_equal</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_17">Return Value<a class="headerlink" href="#return-value_17" title="Permanent link">&#128279;</a></h5>
<ul>
<li><code>batt::OkStatus()</code> if the Watch value was observed to be <code>val</code></li>
<li><code>batt::StatusCode::kClosed</code> if the Watch was closed before <code>val</code> was observed</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchawait_modify"><a href="#battwatcht">batt::Watch</a>::await_modify<a class="headerlink" href="#battwatchawait_modify" title="Permanent link">&#128279;</a></h4>
<p>Retries <code>fn</code> on the Watch value until it succeeds or the Watch is closed.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">await_modify</span><span class="p">(</span><span class="n">Fn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>If <code>fn</code> returns <code>batt::None</code>, this indicates <code>fn</code> should not be called again until a new value is available.</p>
<p><code>fn</code> <strong>MUST</strong> be safe to call multiple times within a single call to <code>await_modify</code>.  This is because <code>await_modify</code> may be implemented via an atomic compare-and-swap loop.</p>
<h5 id="return-value_18">Return Value<a class="headerlink" href="#return-value_18" title="Permanent link">&#128279;</a></h5>
<ul>
<li>If successful, the old (pre-modify) value on which <code>fn</code> finally succeeded</li>
<li><code>batt::StatusCode::kClosed</code> if the Watch was closed before <code>fn</code> was successful</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchawait_not_equal"><a href="#battwatcht">batt::Watch</a>::await_not_equal<a class="headerlink" href="#battwatchawait_not_equal" title="Permanent link">&#128279;</a></h4>
<p>Blocks the current task/thread until the Watch value is <em>not</em> equal to <code>last_seen</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">await_not_equal</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">last_seen</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_19">Return Value<a class="headerlink" href="#return-value_19" title="Permanent link">&#128279;</a></h5>
<ul>
<li>On success, the current value of the Watch, which is guaranteed to <em>not</em> equal <code>last_seen</code></li>
<li><code>batt::StatusCode::kClosed</code> if the Watch was closed before a satisfactory value was observed</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchawait_true"><a href="#battwatcht">batt::Watch</a>::await_true<a class="headerlink" href="#battwatchawait_true" title="Permanent link">&#128279;</a></h4>
<p>Blocks the current task/thread until the passed predicate function returns <code>true</code> for the current value of the Watch.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Pred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">await_true</span><span class="p">(</span><span class="n">Pred</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">pred</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This is the most general of Watch's blocking getter methods.</p>
<h5 id="return-value_20">Return Value<a class="headerlink" href="#return-value_20" title="Permanent link">&#128279;</a></h5>
<ul>
<li>On success, the Watch value for which <code>pred</code> returned <code>true</code></li>
<li><code>batt::StatusCode::kClosed</code> if the Watch was closed before a satisfactory value was observed</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchclose"><a href="#battwatcht">batt::Watch</a>::close<a class="headerlink" href="#battwatchclose" title="Permanent link">&#128279;</a></h4>
<p>Set the Watch to the "closed" state, which disables all blocking/async synchronization on the Watch, immediately unblocking any currently waiting tasks/threads.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>This method is safe to call multiple times.  The Watch value can still be modified and retrieved after it is closed; this only disables the methods in the "Synchronization" category (see Summary section above).</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchfetch_add"><a href="#battwatcht">batt::Watch</a>::fetch_add<a class="headerlink" href="#battwatchfetch_add" title="Permanent link">&#128279;</a></h4>
<p>Atomically adds the specified amount to the Watch value, returning the previous value.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="n">T</span><span class="w"> </span><span class="nf">fetch_add</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><em>NOTE: This method is only available if T is a primitive integer type.</em></p>
<h5 id="return-value_21">Return Value<a class="headerlink" href="#return-value_21" title="Permanent link">&#128279;</a></h5>
<p>The prior value of the Watch.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchfetch_and"><a href="#battwatcht">batt::Watch</a>::fetch_and<a class="headerlink" href="#battwatchfetch_and" title="Permanent link">&#128279;</a></h4>
<p>Atomically sets the Watch value to the bitwise-and of the current value and the passed <code>arg</code>, returning the previous value.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="n">T</span><span class="w"> </span><span class="nf">fetch_and</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><em>NOTE: This method is only available if T is a primitive integer type.</em></p>
<h5 id="return-value_22">Return Value<a class="headerlink" href="#return-value_22" title="Permanent link">&#128279;</a></h5>
<p>The prior value of the Watch.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchfetch_or"><a href="#battwatcht">batt::Watch</a>::fetch_or<a class="headerlink" href="#battwatchfetch_or" title="Permanent link">&#128279;</a></h4>
<p>Atomically sets the Watch value to the bitwise-and of the current value and the passed <code>arg</code>, returning the previous value.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="n">T</span><span class="w"> </span><span class="nf">fetch_or</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><em>NOTE: This method is only available if T is a primitive integer type.</em></p>
<h5 id="return-value_23">Return Value<a class="headerlink" href="#return-value_23" title="Permanent link">&#128279;</a></h5>
<p>The prior value of the Watch.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchfetch_sub"><a href="#battwatcht">batt::Watch</a>::fetch_sub<a class="headerlink" href="#battwatchfetch_sub" title="Permanent link">&#128279;</a></h4>
<p>Atomically subtracts the specified amount to the Watch value, returning the previous value.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">T</span><span class="w"> </span><span class="nf">fetch_sub</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><em>NOTE: This method is only available if T is a primitive integer type.</em></p>
<h5 id="return-value_24">Return Value<a class="headerlink" href="#return-value_24" title="Permanent link">&#128279;</a></h5>
<p>The prior value of the Watch.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchget_value"><a href="#battwatcht">batt::Watch</a>::get_value<a class="headerlink" href="#battwatchget_value" title="Permanent link">&#128279;</a></h4>
<p>Returns the current value of the Watch to the caller.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="n">T</span><span class="w"> </span><span class="nf">get_value</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_25">Return Value<a class="headerlink" href="#return-value_25" title="Permanent link">&#128279;</a></h5>
<p>The current Watch value.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchis_closed"><a href="#battwatcht">batt::Watch</a>::is_closed<a class="headerlink" href="#battwatchis_closed" title="Permanent link">&#128279;</a></h4>
<p>Returns whether the Watch is in a "closed" state.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">is_closed</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h5 id="return-value_26">Return Value<a class="headerlink" href="#return-value_26" title="Permanent link">&#128279;</a></h5>
<ul>
<li><code>true</code> if the Watch is closed</li>
<li><code>false</code> otherwise</li>
</ul>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchmodify"><a href="#battwatcht">batt::Watch</a>::modify<a class="headerlink" href="#battwatchmodify" title="Permanent link">&#128279;</a></h4>
<p>Atomically modifies the Watch value by applying the passed transform <code>fn</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="n">T</span><span class="w"> </span><span class="n">modify</span><span class="p">(</span><span class="n">Fn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><code>fn</code> <strong>MUST</strong> be safe to call multiple times within a single call to <code>modify</code>.  This is because <code>modify</code> may be implemented via an atomic compare-and-swap loop.</p>
<h5 id="return-value_27">Return Value<a class="headerlink" href="#return-value_27" title="Permanent link">&#128279;</a></h5>
<ul>
<li>if <code>T</code> is a primitive integer type (including <code>bool</code>), the new value of the Watch</li>
<li>else, the old value of the Watch</li>
</ul>
<p><strong><em>NOTE: This behavior is acknowledged to be less than ideal and will be fixed in the future to be consistent, regardless of <code>T</code></em></strong></p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchmodify_if"><a href="#battwatcht">batt::Watch</a>::modify_if<a class="headerlink" href="#battwatchmodify_if" title="Permanent link">&#128279;</a></h4>
<p>Retries calling <code>fn</code> on the Watch value until EITHER of: 
  * <code>fn</code> returns <code>batt::None</code>
  * BOTH of: 
    * <code>fn</code> returns a non-<code>batt::None</code> value
    * the Watch value is atomically updated via compare-and-swap</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="n">batt</span><span class="o">::</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">modify_if</span><span class="p">(</span><span class="n">Fn</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fn</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p><code>fn</code> <strong>MUST</strong> be safe to call multiple times within a single call to <code>modify_if</code>.  This is because <code>modify_if</code> may be implemented via an atomic compare-and-swap loop.</p>
<p>Unlike <a href="#battwatchawait_modify">await_modify</a>, this method never puts the current task/thread to sleep; it keeps <em>actively</em> polling the Watch value until it reaches one of the exit criteria described above.</p>
<h5 id="return-value_28">Return Value<a class="headerlink" href="#return-value_28" title="Permanent link">&#128279;</a></h5>
<p>The final value returned by <code>fn</code>, which is either <code>batt::None</code> or the new Watch value.</p>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h4 id="battwatchset_value"><a href="#battwatcht">batt::Watch</a>::set_value<a class="headerlink" href="#battwatchset_value" title="Permanent link">&#128279;</a></h4>
<p>Atomically set the value of the Watch.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">new_value</span><span class="p">);</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<hr>
<p><br><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --></p>
<h2 id="battmutext">batt::Mutex&lt;T&gt;<a class="headerlink" href="#battmutext" title="Permanent link">&#128279;</a></h2>
<h3 id="summary_2">Summary<a class="headerlink" href="#summary_2" title="Permanent link">&#128279;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/mutex.hpp&gt;</span><span class="cp"></span>
</code></pre></div></td></tr></table></div>
<table>
<thead>
<tr>
<th align="left">Constructors</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battmutexmutex">Mutex()</a></td>
</tr>
<tr>
<td align="left"><a href="#battmutexmutexargs">Mutex(args...)</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Methods</th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battmutexlock">lock</a></td>
<td align="left"><a href="#battmutexlock-const">lock (const)</a></td>
<td align="left"><a href="#battmutexwith_lock">with_lock</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Operators</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battmutexoperator-&gt;">operator-&gt;</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th align="left">Static Methods</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="#battmutexthreadsafebase">thread_safe_base</a></td>
</tr>
</tbody>
</table>
<h3 id="description_2">Description<a class="headerlink" href="#description_2" title="Permanent link">&#128279;</a></h3>
<p>Provides mutually-exclusive access to an instance of type <code>T</code>.  This class has two advantages over <code>std::mutex</code>:</p>
<ol>
<li>It will yield the current <code>batt::Task</code> (if there is one) when blocking to acquire a lock, allowing the current thread to be used by other tasks</li>
<li>By embedding the protected type <code>T</code> within the object, there is a much lower chance that state which should be accessed via a mutex will accidentally be accessed directly</li>
</ol>
<p>This mutex implementation is mostly fair because it uses <a href="https://en.wikipedia.org/wiki/Lamport's_bakery_algorithm">Lamport's Bakery Algorithm</a>.  It is non-recursive, so threads/tasks that attempt to acquire a lock that they already have will deadlock.  Also, an attempt to acquire a lock on a <code>batt::Mutex</code> can't be cancelled, so it is not possible to set a timeout on lock acquisition.</p>
<p>An instance of <code>batt::Mutex&lt;T&gt;</code> may be locked in a few different ways:</p>
<h4 id="lock-via-guard-class-similar-to-stdunique_lock">Lock via guard class (similar to std::unique_lock)<a class="headerlink" href="#lock-via-guard-class-similar-to-stdunique_lock" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">Lock</span><span class="w"> </span><span class="n">lock</span><span class="p">{</span><span class="n">s</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-44-4" name="__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">  </span><span class="c1">// Once the lock is acquired, you can access the protected object via pointer...</span>
<a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-44-8" name="__codelineno-44-8"></a>
<a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">  </span><span class="c1">// ... or by reference ...</span>
<a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-44-12" name="__codelineno-44-12"></a>
<a id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">  </span><span class="c1">// ... by operator* like a smart pointer...</span>
<a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ref2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-44-16" name="__codelineno-44-16"></a>
<a id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="w">  </span><span class="c1">// ... or you can access its members via operator-&gt;:</span>
<a id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-44-20" name="__codelineno-44-20"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-44-21" name="__codelineno-44-21"></a><span class="c1">// The lock is released when the guard class goes out of scope.</span>
</code></pre></div></td></tr></table></div>
<p>Equivalently, an instance of <code>batt::Mutex&lt;T&gt;::Lock</code> can be created via the <code>lock()</code> method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span>
<span class="normal"><a href="#__codelineno-45-4">4</a></span>
<span class="normal"><a href="#__codelineno-45-5">5</a></span>
<span class="normal"><a href="#__codelineno-45-6">6</a></span>
<span class="normal"><a href="#__codelineno-45-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">  </span><span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">locked</span><span class="p">),</span><span class="w"> </span><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">                </span><span class="s">&quot;It is nice to use auto in this case!&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>As the second example implies, <code>batt::Mutex&lt;T&gt;::Lock</code> is a movable type (however it is non-copyable).</p>
<h4 id="run-function-with-lock-acquired">Run function with lock acquired<a class="headerlink" href="#run-function-with-lock-acquired" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span>
<span class="normal"><a href="#__codelineno-46-2">2</a></span>
<span class="normal"><a href="#__codelineno-46-3">3</a></span>
<span class="normal"><a href="#__codelineno-46-4">4</a></span>
<span class="normal"><a href="#__codelineno-46-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">{</span><span class="s">&quot;Some string&quot;</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="n">s</span><span class="p">.</span><span class="n">with_lock</span><span class="p">([](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">locked_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="n">locked_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot; and then some!&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="p">});</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h4 id="lock-free-access-to-t">Lock-free access to T<a class="headerlink" href="#lock-free-access-to-t" title="Permanent link">&#128279;</a></h4>
<p>Even though access to the protected object of type <code>T</code> mostly happens via a lock, <code>batt::Mutex</code> supports types with a partial interface that is thread-safe without locking.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span>
<span class="normal"><a href="#__codelineno-47-21">21</a></span>
<span class="normal"><a href="#__codelineno-47-22">22</a></span>
<span class="normal"><a href="#__codelineno-47-23">23</a></span>
<span class="normal"><a href="#__codelineno-47-24">24</a></span>
<span class="normal"><a href="#__codelineno-47-25">25</a></span>
<span class="normal"><a href="#__codelineno-47-26">26</a></span>
<span class="normal"><a href="#__codelineno-47-27">27</a></span>
<span class="normal"><a href="#__codelineno-47-28">28</a></span>
<span class="normal"><a href="#__codelineno-47-29">29</a></span>
<span class="normal"><a href="#__codelineno-47-30">30</a></span>
<span class="normal"><a href="#__codelineno-47-31">31</a></span>
<span class="normal"><a href="#__codelineno-47-32">32</a></span>
<span class="normal"><a href="#__codelineno-47-33">33</a></span>
<span class="normal"><a href="#__codelineno-47-34">34</a></span>
<span class="normal"><a href="#__codelineno-47-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">MyStateBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">init_val</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">initial_value</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">init_val</span><span class="p">)}</span><span class="w"></span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">  </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">initial_value</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="k">struct</span><span class="w"> </span><span class="nc">MyState</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MyStateBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">  </span><span class="c1">// IMPORTANT: this member type alias tells batt::Mutex to enable the `no_lock()` method/feature.</span>
<a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ThreadSafeBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-47-13" name="__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">MyState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">init_val</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">{</span><span class="n">init_val</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">current_value</span><span class="p">{</span><span class="n">init_val</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="w">  </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-47-19" name="__codelineno-47-19"></a>
<a id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">MyState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">state</span><span class="p">{</span><span class="s">&quot;initial&quot;</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-47-21" name="__codelineno-47-21"></a>
<a id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="c1">// No lock needed to read a const value.</span>
<a id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="c1">//</span>
<a id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;initial value = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">no_lock</span><span class="p">().</span><span class="n">initial_value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-47-25" name="__codelineno-47-25"></a>
<a id="__codelineno-47-26" name="__codelineno-47-26"></a><span class="c1">// We still need to acquire the lock to access the derived class.</span>
<a id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="c1">//</span>
<a id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="n">state</span><span class="p">.</span><span class="n">with_lock</span><span class="p">([](</span><span class="n">MyState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-29" name="__codelineno-47-29"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;current value = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">current_value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">current_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;changed&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-47-31" name="__codelineno-47-31"></a><span class="p">});</span><span class="w"></span>
<a id="__codelineno-47-32" name="__codelineno-47-32"></a>
<a id="__codelineno-47-33" name="__codelineno-47-33"></a><span class="c1">// batt::Mutex::nolock returns a reference to the ThreadSafeBase type declared in MyState.</span>
<a id="__codelineno-47-34" name="__codelineno-47-34"></a><span class="c1">//</span>
<a id="__codelineno-47-35" name="__codelineno-47-35"></a><span class="n">MyStateBase</span><span class="o">&amp;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">no_lock</span><span class="p">();</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - --><!-- ==#==========+==+=+=++=+++++++++++-+-+--+----- --- -- -  -  -   - -->




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>