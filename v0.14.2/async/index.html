
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.6">
    
    
      
        <title><batteries/async/...> : Async Tasks and I/O - Batteries C++</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#quick-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Batteries C++" class="md-header__button md-logo" aria-label="Batteries C++" data-md-component="logo">
      <img width="100px" src="/images/BatteriesLogo.png">
<script src="/jquery-3.6.0.min.js"></script>
<script src="/releaseNavOptions.js" type="application/javascript"></script>
<script src="/releaseNav.js" type="application/javascript"></script>
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Batteries C++
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              &lt;batteries/async/...&gt; : Async Tasks and I/O
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Batteries C++" class="md-nav__button md-logo" aria-label="Batteries C++" data-md-component="logo">
      <img width="100px" src="/images/BatteriesLogo.png">
<script src="/jquery-3.6.0.min.js"></script>
<script src="/releaseNavOptions.js" type="application/javascript"></script>
<script src="/releaseNav.js" type="application/javascript"></script>
    </a>
    Batteries C++
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://gitlab.com/batteriescpp/batteries/" class="md-nav__link">
        GitLab Repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Headers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Headers" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Headers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../assert.hpp" class="md-nav__link">
        batteries/assert.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="." class="md-nav__link">
        batteries/async/*
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../case_of.hpp" class="md-nav__link">
        batteries/case_of.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cpu_align.hpp" class="md-nav__link">
        batteries/cpu_align.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../seq" class="md-nav__link">
        batteries/seq.hpp
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../status.hpp" class="md-nav__link">
        batteries/status.hpp
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_autogen/Files/" class="md-nav__link">
        Files
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_autogen/Classes/" class="md-nav__link">
        Classes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Developers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Developers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../coding_style" class="md-nav__link">
        Coding Style
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/configure-ci-pipelines" class="md-nav__link">
        Configuring CI Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/write-the-docs" class="md-nav__link">
        Writing Documentation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#quick-reference" class="md-nav__link">
    Quick Reference
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#batttask" class="md-nav__link">
    batt::Task
  </a>
  
    <nav class="md-nav" aria-label="batt::Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-io" class="md-nav__link">
    Asynchronous I/O
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-scheduling-and-priorities" class="md-nav__link">
    Task Scheduling and Priorities
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synchronization-primitives" class="md-nav__link">
    Synchronization Primitives
  </a>
  
    <nav class="md-nav" aria-label="Synchronization Primitives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#battwatch" class="md-nav__link">
    batt::Watch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battmutex" class="md-nav__link">
    batt::Mutex
  </a>
  
    <nav class="md-nav" aria-label="batt::Mutex">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lock-via-guard-class-similar-to-stdunique_lock" class="md-nav__link">
    Lock via guard class (similar to std::unique_lock)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-via-lock-method" class="md-nav__link">
    Lock via lock() method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-function-with-lock-acquired" class="md-nav__link">
    Run function with lock acquired
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-free-access-to-t" class="md-nav__link">
    Lock-free access to T
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battchannel" class="md-nav__link">
    batt::Channel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battfuture" class="md-nav__link">
    batt::Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battgrant" class="md-nav__link">
    batt::Grant
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battlatch" class="md-nav__link">
    batt::Latch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#battqueue" class="md-nav__link">
    batt::Queue
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="batteriesasync-async-tasks-and-io">&lt;batteries/async/...&gt; : Async Tasks and I/O<a class="headerlink" href="#batteriesasync-async-tasks-and-io" title="Permanent link">&#128279;</a></h1>
<h2 id="quick-reference">Quick Reference<a class="headerlink" href="#quick-reference" title="Permanent link">&#128279;</a></h2>
<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Channel">batt::Channel&lt;T&gt;</a></td>
<td align="left">Unbuffered single-producer/single-consumer (SPSC) communcation channel between Tasks</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Future">batt::Future&lt;T&gt;</a></td>
<td align="left">An asynchronously generated value of type T</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Grant">batt::Grant</a></td>
<td align="left">Counted resource allocation/sychronization (similar to counting semaphore)</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Latch">batt::Latch&lt;T&gt;</a></td>
<td align="left">A write-once, single-value synchronized container.  Similar to Future/Promise, but guaranteed not to alloc and has no defined copy/move semantics.</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Mutex">batt::Mutex&lt;T&gt;</a></td>
<td align="left">Mutual exclusion for use with batt::Task</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Queue">batt::Queue&lt;T&gt;</a></td>
<td align="left">Unbounded multi-producer/multi-consumer (MPMC) FIFO queue.</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Task">batt::Task</a></td>
<td align="left">Lightweight user-space thread for async I/O and high-concurrency programs.</td>
</tr>
<tr>
<td align="left"><a href="/_autogen/Classes/classbatt_1_1Watch">batt::Watch&lt;T&gt;</a></td>
<td align="left">Atomic variable with synchronous and asynchronous change notification.</td>
</tr>
<tr>
<td align="left"><nobr><a href="/_autogen/Files/handler_8hpp">&lt;batteries/async/handler.hpp&gt;</a></nobr></td>
<td align="left">Utilities for managing asynchronous callback handlers</td>
</tr>
</tbody>
</table>
<h2 id="batttask">batt::Task<a class="headerlink" href="#batttask" title="Permanent link">&#128279;</a></h2>
<p><a href="/_autogen/Classes/classbatt_1_1Task">API Reference</a></p>
<p>A <code>batt::Task</code> is similar to <code>std::thread</code>, but much lighter weight.  Like <code>std::thread</code>, each <code>batt::Task</code> has an independent call stack.  Unlike <code>std::thread</code>, however, <code>batt::Task</code> is implemented 100% in user space, and does not support preemption.  This makes the context swap overhead of <code>batt::Task</code> very low in comparison to a <code>std::thread</code>, which means it is possible to have many more <code>batt::Task</code> instances without losing efficiency.</p>
<h3 id="asynchronous-io">Asynchronous I/O<a class="headerlink" href="#asynchronous-io" title="Permanent link">&#128279;</a></h3>
<p>The primary use case for <code>batt::Task</code> is to support asynchronous I/O for efficiency, while retaining the programming model of traditional threads.  This makes asynchronous code much easier to write, read, debug, and maintain than equivalent code using asynchronous continuation handlers (in the style of Boost Asio or Node.js).</p>
<p>An important feature of <code>batt::Task</code> to highlight is the static method <a href="#batttaskawait">batt::Task::await</a>.  This method allows the use of asynchronous continuation handler-based APIs (e.g., Boost Asio) in a "blocking" style.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/task.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/io_result.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/assert.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/utility.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/asio/io_context.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/asio/ip/tcp.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="c1">// Some function to get a server endpoint to which </span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="c1">// to connect.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="c1">//</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">extern</span><span class="w"> </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">endpoint</span><span class="w"> </span><span class="nf">get_server_endpoint</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="c1">// Create an io_context to schedule our Task and manage </span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">  </span><span class="c1">// all asynchronous I/O.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">io_context</span><span class="w"> </span><span class="n">io</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="c1">// Create a TCP/IP socket; we will use this to connect </span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">  </span><span class="c1">// to the server endpoint.</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">tcp</span><span class="o">::</span><span class="n">socket</span><span class="w"> </span><span class="n">s</span><span class="p">{</span><span class="n">io</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">  </span><span class="c1">// Launch a task to act as our client.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">client_task</span><span class="p">{</span><span class="n">io</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="cm">/*body_fn=*/</span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="w"> </span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">      </span><span class="c1">// Connect to the server.  batt::Task::await will not </span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">      </span><span class="c1">// return until the handler passed to `async_connect`</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">      </span><span class="c1">// has been invoked.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">      </span><span class="c1">//</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">      </span><span class="n">boost</span><span class="o">::</span><span class="n">system</span><span class="o">::</span><span class="n">error_code</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="o">::</span><span class="n">await</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">system</span><span class="o">::</span><span class="n">error_code</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">          </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">handler</span><span class="p">){</span><span class="w"></span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="n">s</span><span class="p">.</span><span class="n">async_connect</span><span class="p">(</span><span class="n">get_server_endpoint</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">                            </span><span class="n">BATT_FORWARD</span><span class="p">(</span><span class="n">handler</span><span class="p">));</span><span class="w"></span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">          </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">      </span><span class="n">BATT_CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">ec</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">      </span><span class="c1">// Interact with the server via the connected socket...</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">    </span><span class="p">}};</span><span class="w"></span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">  </span><span class="c1">// VERY IMPORTANT: without this line, nothing will happen!</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>All continuation handler based async APIs require a callback (the continuation handler).  In order to simplify the code, we want to "pause" our code until the I/O is finished, but the async API, <code>async_connect</code> in this case, will return immediately.  <a href="#batttaskawait">batt::Task::await</a> gives us access to the "continuation" of the task, in this case everything that happens after <code>await</code> returns, as a handler that can be passed directly to <code>async_connect</code>.  All the context swapping, scheduling, memory managment, and synchronization is handled automatically by <code>batt::Task</code>, allowing the programmer to focus on the application's natural flow of control, and not the mechanics used to implement this flow.</p>
<h3 id="task-scheduling-and-priorities">Task Scheduling and Priorities<a class="headerlink" href="#task-scheduling-and-priorities" title="Permanent link">&#128279;</a></h3>
<p>When a <code>batt::Task</code> is created, it is passed a Boost Asio executor object.  All execution of task code on the task's stack will happen via <code>boost::asio::dispatch</code> or <code>boost::asio::post</code> using this executor.  NOTE: this means if, for example, you use the executor from a <code>boost::asio::io_context</code> to create a task, that task will not run unless you call <code>io_context::run()</code>!</p>
<p>A running <code>batt::Task</code> is never preempted by another task.  Instead it must yield control of the current thread to allow another task to run.  There are four ways to do this:</p>
<ul>
<li><a href="#batttaskjoin">batt::Task::join()</a></li>
<li><a href="#batttaskawait">batt::Task::await()</a></li>
<li><a href="#batttaskyield">batt::Task::yield()</a></li>
<li><a href="#batttasksleep">batt::Task::sleep()</a></li>
</ul>
<p>WARNING: if you use a kernel or standard library synchronization mechanism or blocking call, for example <code>std::mutex</code>, from inside a <code>batt::Task</code>, that task WILL NOT YIELD!  This is why the Batteries Async library contains its own synchronization primitives, like <code>batt::Watch</code>, <code>batt::Queue</code>, and <code>batt::Mutex</code>.  All of these primitives are implemented on top one or more of the four methods enumerated above.</p>
<p>Each <code>batt::Task</code> is assigned a scheduling priority, which is a signed 32-bit integer.  Greater values of the priority int mean more urgent priority; lesser values mean less urgency.  Even though tasks don't interrupt each other (i.e. preemption), they sometimes perform actions that cause another task to move from a "waiting" state to a "ready to run" state.  For example, one task may be blocked inside a call to <code>batt::Watch&lt;T&gt;::await_equal</code>, and another task (let's call it the "notifier") may call <code>batt::Watch&lt;T&gt;::set_value</code>, activating the first task (let's call it the "listener").  As noted above, the newly activated ("listener") task will be run via <code>boost::asio::dispatch</code> or <code>boost::asio::post</code>.  Which mechanism is used depends on the relative priority of the two tasks:</p>
<ul>
<li>If the "notifier" has a higher (numerically greater) priority value than the "listener", the "listener" is scheduled via <code>boost::asio::post</code>.</li>
<li>Otherwise, the "notifier" is immediately suspended and re-scheduled via <code>boost::asio::post</code>; then the "listener" is scheduled via <code>boost::asio::dispatch</code>.</li>
</ul>
<p>In any case, activating another task will <em>not</em> cause a running task to go from a "running" state to a "waiting" state.  It may however "bounce" it to another thread, or to be pushed to the back of an execution queue.  This only matters when there are more tasks ready to run than there are available threads for a given ExecutionContext: higher priority tasks are scheduled before lower priority ones in general.</p>
<p>NOTE: you may still end up with a priority inversion situation when multiple tasks with different priorities are <code>boost::asio::post</code>-ed to the same queue.  In this case, there is no mechanism currently for re-ordering the tasks to give preference based on priority.</p>
<p>Overall, it is best to consider priority "best-effort" rather than a guarantee of scheduling order.  It should be used for performance tuning, not to control execution semantics in a way that affects the functional behavior of a program.</p>
<h2 id="synchronization-primitives">Synchronization Primitives<a class="headerlink" href="#synchronization-primitives" title="Permanent link">&#128279;</a></h2>
<h3 id="battwatch">batt::Watch<a class="headerlink" href="#battwatch" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Watch">API Reference</a></p>
<p>Watch is the simplest of Batteries' synchronization mechanisms.  It is like an atomic variable with the ability to wait on changes.  This is similar to a <a href="https://en.wikipedia.org/wiki/Futex">Futex</a>, and is used to implement the other synchronization primitives at a low level.</p>
<h3 id="battmutex">batt::Mutex<a class="headerlink" href="#battmutex" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Mutex">API Reference</a></p>
<p>Mutex provides mutual exclusion to an object.  It is based on batt::Watch, so it is fair, but it will not scale well as the number of tasks/threads attempting to acquire a Mutex concurrently.  It is up to the application programmer to avoid high levels of contention for a single Mutex.</p>
<p>An instance of <code>batt::Mutex&lt;T&gt;</code> may be locked in a few different ways:</p>
<h4 id="lock-via-guard-class-similar-to-stdunique_lock">Lock via guard class (similar to std::unique_lock)<a class="headerlink" href="#lock-via-guard-class-similar-to-stdunique_lock" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">Lock</span><span class="w"> </span><span class="n">lock</span><span class="p">{</span><span class="n">s</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="c1">// Once the lock is acquired, you can access the protected object</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="c1">// via pointer...</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="c1">// ... or by reference ...</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="n">value</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="c1">// ... by operator* like a smart pointer...</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ref2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="c1">// ... or you can access its members via operator-&gt;:</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="c1">// The lock is released when the guard class goes out of scope.</span>
</code></pre></div></td></tr></table></div>
<h4 id="lock-via-lock-method">Lock via lock() method<a class="headerlink" href="#lock-via-lock-method" title="Permanent link">&#128279;</a></h4>
<p>Equivalently, an instance of <code>batt::Mutex&lt;T&gt;::Lock</code> can be created via the <code>lock()</code> method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span>
<span class="normal"><a href="#__codelineno-2-6">6</a></span>
<span class="normal"><a href="#__codelineno-2-7">7</a></span>
<span class="normal"><a href="#__codelineno-2-8">8</a></span>
<span class="normal"><a href="#__codelineno-2-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">locked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="k">static_assert</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">locked</span><span class="p">),</span><span class="w"> </span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">                   </span><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">Lock</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="s">&quot;It is nice to use auto in this case!&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<p>As the second example implies, <code>batt::Mutex&lt;T&gt;::Lock</code> is a movable type (however it is non-copyable).</p>
<h4 id="run-function-with-lock-acquired">Run function with lock acquired<a class="headerlink" href="#run-function-with-lock-acquired" title="Permanent link">&#128279;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">s</span><span class="p">{</span><span class="s">&quot;Some string&quot;</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">s</span><span class="p">.</span><span class="n">with_lock</span><span class="p">([](</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">locked_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">locked_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot; and then some!&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">});</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h4 id="lock-free-access-to-t">Lock-free access to T<a class="headerlink" href="#lock-free-access-to-t" title="Permanent link">&#128279;</a></h4>
<p>Even though access to the protected object of type <code>T</code> mostly happens via a lock, <code>batt::Mutex</code> supports types with a partial interface that is thread-safe without locking.  Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Since lock-free access to a type is by definition</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">// a subset of all access to that type, we define</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">// a base class containing all lock-free fields and</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1">// member functions.</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1">//</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="k">struct</span><span class="w"> </span><span class="nc">MyStateBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">init_val</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">initial_value</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">init_val</span><span class="p">)}</span><span class="w"></span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">  </span><span class="c1">// This is safe to access concurrently because it is</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="c1">// const.</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">initial_value</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="k">struct</span><span class="w"> </span><span class="nc">MyState</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MyStateBase</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">  </span><span class="c1">// IMPORTANT: this member type alias tells batt::Mutex to</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">  </span><span class="c1">// enable the `no_lock()` method/feature.</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="n">ThreadSafeBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">MyState</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">init_val</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">MyStateBase</span><span class="p">{</span><span class="n">init_val</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">current_value</span><span class="p">{</span><span class="n">init_val</span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">  </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">  </span><span class="c1">// Because this field is non-const, it must be accessed</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">  </span><span class="c1">// while holding a lock.</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">current_value</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="n">batt</span><span class="o">::</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">MyState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">state</span><span class="p">{</span><span class="s">&quot;initial&quot;</span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="c1">// batt::Mutex::nolock returns a reference to the </span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="c1">// ThreadSafeBase type declared in MyState.</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="c1">//</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="n">MyStateBase</span><span class="o">&amp;</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">no_lock</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="c1">// No lock needed to read a const value.</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="c1">//</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;initial value = &quot;</span><span class="w"> </span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">          </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">base</span><span class="p">.</span><span class="n">initial_value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="c1">// We still need to acquire the lock to access the derived</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="c1">// class.</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="c1">//</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="n">state</span><span class="p">.</span><span class="n">with_lock</span><span class="p">([](</span><span class="n">MyState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;current value = &quot;</span><span class="w"> </span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">current_value</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">current_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;changed&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="p">});</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h3 id="battchannel">batt::Channel<a class="headerlink" href="#battchannel" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Channel">API Reference</a></p>
<p>Channel is a simple unbuffered SPSC primitive for transferring information between two tasks.  It can be used to implement zero-copy communication between tasks.</p>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span>
<span class="normal"><a href="#__codelineno-5-45">45</a></span>
<span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span>
<span class="normal"><a href="#__codelineno-5-48">48</a></span>
<span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/channel.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/async/task.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;batteries/assert.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/asio/io_context.hpp&gt;</span><span class="cp"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">io_context</span><span class="w"> </span><span class="n">io</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">  </span><span class="c1">// Create a channel to pass strings between tasks.</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Channel</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">  </span><span class="c1">// The producer task reads lines from stdin until it gets an empty line.</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">producer</span><span class="p">{</span><span class="n">io</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">]{</span><span class="w"></span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">    </span><span class="c1">// Keep reading lines until an empty line is read.</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="c1">//</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">      </span><span class="n">batt</span><span class="o">::</span><span class="n">Status</span><span class="w"> </span><span class="n">write_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">      </span><span class="n">BATT_CHECK_OK</span><span class="p">(</span><span class="n">write_status</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="w">    </span><span class="c1">// Let the consumer task know we are done.</span>
<a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">    </span><span class="c1">//</span>
<a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">    </span><span class="n">channel</span><span class="p">.</span><span class="n">close_for_write</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">  </span><span class="p">}};</span><span class="w"></span>
<a id="__codelineno-5-39" name="__codelineno-5-39"></a>
<a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="w">  </span><span class="c1">// The consumer tasks reads strings from the channel, printing them to stdout</span>
<a id="__codelineno-5-41" name="__codelineno-5-41"></a><span class="w">  </span><span class="c1">// until the channel is closed.</span>
<a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="w">  </span><span class="c1">//</span>
<a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">  </span><span class="n">batt</span><span class="o">::</span><span class="n">Task</span><span class="w"> </span><span class="n">consumer</span><span class="p">{</span><span class="n">io</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">]{</span><span class="w"></span>
<a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="w">      </span><span class="n">batt</span><span class="o">::</span><span class="n">StatusOr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&gt;</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="n">read</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">line</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-49" name="__codelineno-5-49"></a>
<a id="__codelineno-5-50" name="__codelineno-5-50"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">line</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-51" name="__codelineno-5-51"></a>
<a id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="w">      </span><span class="c1">// Important: signal to the producer that we are done with the string!</span>
<a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">      </span><span class="c1">//</span>
<a id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="w">      </span><span class="n">channel</span><span class="p">.</span><span class="n">consume</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-5-56" name="__codelineno-5-56"></a>
<a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">    </span><span class="n">channel</span><span class="p">.</span><span class="n">close_for_read</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="w">  </span><span class="p">}};</span><span class="w"></span>
<a id="__codelineno-5-59" name="__codelineno-5-59"></a>
<a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-61" name="__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="w">  </span><span class="n">producer</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-63" name="__codelineno-5-63"></a><span class="w">  </span><span class="n">consumer</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-5-64" name="__codelineno-5-64"></a>
<a id="__codelineno-5-65" name="__codelineno-5-65"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></td></tr></table></div>
<h3 id="battfuture">batt::Future<a class="headerlink" href="#battfuture" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Future">API Reference</a></p>
<h3 id="battgrant">batt::Grant<a class="headerlink" href="#battgrant" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Grant">API Reference</a></p>
<h3 id="battlatch">batt::Latch<a class="headerlink" href="#battlatch" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Latch">API Reference</a></p>
<p>If you don't need to move the Latch, then this mechanism is strictly more efficient than Future/Promise or Mutex.</p>
<h3 id="battqueue">batt::Queue<a class="headerlink" href="#battqueue" title="Permanent link">&#128279;</a></h3>
<p><a href="/_autogen/Classes/classbatt_1_1Queue">API Reference</a></p>
<p>Note: This is an <em>unbounded</em> FIFO implementation, so a back-pressure or rate-limiting mechanism is needed to prevent buffer bloat.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
    
  </body>
</html>